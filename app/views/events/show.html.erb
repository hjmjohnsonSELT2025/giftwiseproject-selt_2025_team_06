<div class="event-wrapper">
  <div class="event-card2">

    <style>
        .event-layout-grid {
            display: grid;
            grid-template-columns: 260px 1fr 320px;
            gap: 24px;
            align-items: start;
        }

        .event-left-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .event-middle-column {
            min-width: 0;
        }

        .event-right-column {
            min-width: 0;
        }

        .invite-container {
            background: #f8f9fc;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }
    </style>

    <div class="event-layout-grid">
      <div class="event-left-column">
          <div class="invite-container">
            <h2>Attendees</h2>
            <div class="attendee-list-scroll">
              <% accepted_invites = @event.invites.where(status: "accepted") %>

              <% if accepted_invites.empty? %>
                <p class="no-attendees">No one is coming yet.</p>
              <% else %>
                <ul class="attendee-list">
                  <% accepted_invites.each do |invite| %>
                    <% attendee = invite.user %>
                    <% next if attendee.nil? %>

                    <li class="attendee-item">
                      <strong><%= attendee.username %></strong>
                    </li>
                  <% end %>
                </ul>
              <% end %>
            </div>

          </div>
        <div class="invite-container">
          <h3>Invite a Friend</h3>

          <% if @friends_not_coming.any? %>
            <%= form_with url: invite_friends_event_path(@event),
                          method: :post,
                          local: true,
                          class: "invite-form" do %>

              <div class="friend-scroll">
                <% @friends_not_coming.each do |friend| %>
                  <label class="friend-row">
                    <%= check_box_tag "friend_ids[]", friend.id %>
                    <span><%= friend.username %></span>
                  </label>
                <% end %>
              </div>

              <button type="submit" class="invite-button">
                Invite Selected Friends
              </button>
            <% end %>
          <% else %>
            <p class="no-attendees">All your friends are already invited or attending.</p>
          <% end %>
        </div>

<!--        <div class="invite-container">-->
<!--          <h3>Add a Recipient</h3>-->
          <%#= form_tag add_recipient_event_path(@event), method: :post, class: "invite-form" do %>
<!--            <input type="text"-->
<!--                   name="username"-->
<!--                   placeholder="Enter recipient username..."-->
<!--                   class="invite-input" />-->
<!--            <button type="submit" class="invite-button">Add Recipient</button>-->
          <%# end %>
<!--        </div>-->
      </div>
      <div class="event-middle-column">

          <h1><%= @event.title %></h1>

          <% if flash[:alert] %>
            <p class="alert"><%= flash[:alert] %></p>
          <% elsif flash[:notice] %>
            <p class="notice"><%= flash[:notice] %></p>
          <% end %>

          <div class="event-detail">
            <p><strong>Date:</strong> <%= @event.event_date %></p>
            <p><strong>Location:</strong> <%= @event.location %></p>
            <p><strong>Budget:</strong> <%= @event.budget %></p>
            <p><strong>Theme:</strong> <%= @event.theme %></p>
            <p><strong>Host:</strong> <%= @event.host.username %></p>
          </div>

          <% if current_user.id == @event.user_id %>
            <h2>Gift Assignments</h2>

            <% if @gift_assignments.empty? %>
              <p class="no-assignments">No gift assignments yet.</p>
            <% else %>
              <div class="invite-container">

                <% @gift_assignments.each do |giver, assignments| %>
                  <div class="assignment-group" style="margin-bottom: 20px;">

                    <!-- GIVER HEADER + SAME ASSIGN RECIPIENT BUTTON -->
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <strong><%= giver.username %></strong>

                      <%= link_to "Assign Recipient",
                                  event_path(@event, assigning_giver_id: giver.id),
                                  class: "invite-button" %>
                    </div>

                    <!-- EXISTING ASSIGNMENTS -->
                    <% if assignments.any? { |a| a.recipient.present? } %>
                      <ul class="attendee-list" style="margin-top: 8px; margin-left: 10px;">
                        <% assignments.each do |entry| %>
                          <% next if entry.recipient.nil? %>

                          <li class="attendee-item"
                              style="display: flex; justify-content: space-between; align-items: center;">

                <span>
                  → <%= entry.recipient.username %>
                  <% if entry.gift %>
                    — <em><%= entry.gift.name %></em>
                  <% else %>
                    <span class="muted">(No gift chosen yet)</span>
                  <% end %>
                </span>

                            <%= button_to "Remove",
                                          remove_assignment_event_path(
                                            @event,
                                            giver_id: giver.id,
                                            recipient_id: entry.recipient.id
                                          ),
                                          method: :post,
                                          class: "remove-attendee-btn",
                                          data: { confirm: "Remove this assignment only?" } %>
                          </li>
                        <% end %>
                      </ul>
                    <% else %>
                      <p class="muted" style="margin-left: 10px;">
                        No recipients assigned yet
                      </p>
                    <% end %>

                    <!-- SECOND STEP: SAME ASSIGN BUTTONS YOU ALREADY HAD -->
                    <% if params[:assigning_giver_id].to_i == giver.id %>
                      <ul class="attendee-list" style="margin-top: 10px; margin-left: 10px;">
                        <% @event.invites.where(status: "accepted").each do |invite| %>
                          <% attendee = invite.user %>
                          <% next if attendee.nil? || attendee.id == giver.id %>

                          <li class="attendee-item">
                            <span><%= attendee.username %></span>

                            <%= button_to "Assign",
                                          assign_roles_event_path(
                                            @event,
                                            giver_id: giver.id,
                                            recipient_id: attendee.id
                                          ),
                                          method: :post,
                                          class: "invite-button" %>
                          </li>
                        <% end %>
                      </ul>
                    <% end %>

                  </div>
                <% end %>

              </div>
            <% end %>
      <% end %>

        </div>
      <div class="event-right-column">

        <div class="invite-container">
          <h3>Your Gift Assignments</h3>

          <% if @recipients_for_current_user.empty? %>
            <p class="no-assignments">You have no assigned recipients for this event.</p>
          <% else %>
            <ul class="attendee-list">
              <% @recipients_for_current_user.each do |entry| %>
                <% next if entry.recipient.nil? %>

                <li class="attendee-item">
                  <span>
                    <strong><%= entry.recipient.username %></strong>
                    <% if entry.gift %>
                      — <em><%= entry.gift.name %></em>
                    <% end %>
                  </span>

                  <div>
                    <% if entry.gift %>
                      <%= button_to "Remove Gift",
                                    remove_gift_event_path(@event.id, entry.recipient.id),
                                    method: :post,
                                    class: "remove-attendee-btn" %>
                    <% else %>
                      <%= link_to "Choose Gift",
                                  add_event_gift_path(@event, recipient_id: entry.recipient.id),
                                  class: "invite-button" %>
                    <% end %>
                  </div>
                </li>
              <% end %>
            </ul>
          <% end %>
        </div>

        <% if current_user.id == @event.user_id %>
          <div class="invite-container">
            <h3>Invite a User</h3>
            <%= form_tag invite_event_path(@event), method: :post, class: "invite-form" do %>
              <input type="text"
                     name="username"
                     placeholder="Enter username..."
                     class="invite-input" />
              <button type="submit" class="invite-button">Invite</button>
            <% end %>
          </div>
        <% end %>

        <div style="margin-top: 20px;">
          <%= link_to "Back to All Events", events_path, class: "btn btn-default" %>
        </div>
      </div>
    </div>



  </div>
</div>
<style>
    .friend-scroll {
        max-height: 140px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 8px;
        margin-bottom: 10px;
    }

    .friend-row {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 0;
        cursor: pointer;
    }
</style>